<!DOCTYPE html>
<html>

<head>
<title>Gumtree Ads on a Map</title>

<link rel="icon" type="image/png" href="map.png">
<link rel="image_src" type="image/png" href="facebook.jpg">

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link href="materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"/>

<link href="style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

<link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
</head>

<body>

<menu></menu>

<div id="map"></div>

<script src="menu.html" type="riot/tag"></script>
<script src="riot+compiler.min.js"></script>

<script type="text/javascript">
lang = "en";

if(localStorage.lang) lang = localStorage.lang;
else if (["fr","fr-fr","fr-FR", "fr-BE", "fr-CA", "fr-CH", "fr-LU"].indexOf(navigator.language) > -1){
	lang = "fr";
} else if (["pl","pl-PL"].indexOf(navigator.language) > -1){
	lang = "pl";
}
localStorage.lang = lang;

riot.mount('*');
</script>

<script src="jquery-2.1.1.min.js"></script>
<script src="materialize.min.js"></script>

<!-- <script src="centreville.js"></script> -->
<script src="firebase-app.js"></script>
<script src="firebase-database.js"></script>
<!-- <script type="text/javascript" src="date.js"></script> -->

<script>

if(lang == "fr") $("title").text("Cartes des annonces Gumtree");
if(lang == "pl") $("title").text("Mapa ogłoszeń Gumtree");

function log(e){ console.log(e) }

var config = {
	apiKey: "AIzaSyBBTr8Y6vt7VTLKRUdZ2QE6rdYH4Ls7lN0",
	authDomain: "gumtree-hacker.firebaseapp.com",
	databaseURL: "https://gumtree-hacker.firebaseio.com",
	projectId: "gumtree-hacker",
	storageBucket: "gumtree-hacker.appspot.com",
	messagingSenderId: "846484105723"
};

// var config = {
//     apiKey: "AIzaSyDD6JfW3qPYs2Z6KnbLeETj2hqTLjp0i1A",
//     authDomain: "carbonimpact-7eac0.firebaseapp.com",
//     databaseURL: "https://carbonimpact-7eac0.firebaseio.com",
//     storageBucket: "carbonimpact-7eac0.appspot.com",
//     messagingSenderId: "781862655051"
// };
firebase.initializeApp(config);

var database = firebase.database();

var flats = [];
var krakow = {lat: 50.0646501, lng: 19.9449799};
price = Infinity;
today = false;


function downloadFlats(){
	
	database.ref('smalls').once('value').then(function(snapshot) {
		log("flats arrived")
		
		saveFlats(snapshot)

		if(map){
			addMarkers();
			addDialogs();
		}
	});
}
downloadFlats();


function saveFlats(snapshot){
	flats.forEach(f => {
		if(f.marker){
			f.marker.setMap(null);
		}
	})
	flats = [];
	var fl = snapshot.val();
	// console.log(fl)
	for(var i in fl) {
			// console.log(fl[i])
			var j = fl[i]["Data dodania"].split("/")
			var d = new Date();
			fl[i].today = parseInt(j[0]) == d.getDate() && parseInt(j[1]) == d.getMonth()+1;
			flats.unshift(fl[i]);
	}
}

database.ref("lastupdate").on('value', function(snapshot) {

	// saveFlats(snapshot);
})

var map,
	blueMarker,
	blueInfoWindow;

function initMap() {

	log("initMap")
	map = new google.maps.Map(document.getElementById('map'), {
		zoom: 14,
		center: krakow
	});
	blueMarker = new google.maps.Marker({
		position: krakow,
		map: map,
		title: "The others",
		icon: blueIcon
	});
	if(flats.length){
		addMarkers();
		addDialogs();
	}
}
var openDialog;

function addDialogs(){
	var bezText = "";

	flats.forEach(f => {

		if( isFiltered(f)){
			if(f.marker){
				if(f.infowindow){
					f.infowindow.setContent( textwind(f) )
				} else {
					f.infowindow = new google.maps.InfoWindow({
						content: textwind(f)
					});
							
					f.marker.addListener('click', function() {
						// log("Just clicked a dot")
						if(openDialog == f.infowindow){
							f.infowindow.close();
							openDialog = "";
							return true;
						}
						f.infowindow.open(map, f.marker);
						if(openDialog){
							openDialog.close();
						}
						openDialog = f.infowindow;
						if(!f.clickevent){
							f.clickevent = true;
							$("#"+f.id).on("click",e=>{log("lol tu m'as vu "+f.id); saveClick(f)})
						}
						// log(f)
						// saveClick(f);
					});

					f.infowindow.addListener('closeclick', function(){
						openDialog = "";
					})
				}
	
			} else {
				bezText = bezText + textwind(f);
			}
		}
	})

	if(blueInfoWindow){
		blueInfoWindow.setContent(bezText)

	} else {

		blueInfoWindow = new google.maps.InfoWindow({
			content: bezText
		});
		// console.log(infowindow)

		blueMarker.addListener('click', function listener(){
			blueInfoWindow.open(map, blueMarker);

			if(openDialog == blueInfoWindow){
				blueInfoWindow.close();
				openDialog = "";
				return true;
			}
			if(openDialog){
				openDialog.close();
			}
			openDialog = blueInfoWindow;
		});

		blueInfoWindow.addListener('closeclick', function(){
			openDialog = "";
		})
	}
	// blueMarker.addListener('click', listener);
}



function addMarkers(){
	flats.forEach(f => {
		var streets = Object.keys(f.streets || {});
			
		// console.log(Math.abs(f.lat-krakow.lat)+Math.abs(f.lng-krakow.lng))
		// if the lat lng is far enough from the center
		if(Math.abs(f.lat-krakow.lat)+Math.abs(f.lng-krakow.lng) > 0.0000002){
			f.position = {lat: parseFloat(f.lat), lng: parseFloat(f.lng)} ;
			f.icon = redIcon;
		} else if(streets.length) {

			var rues = [];
			streets.forEach(e => { rues.push(f.streets[e]) })
			rues = rues.sort((a,b) => {
				if(a.found == "title" && b.found == "description") return 1;
				if(a.found == "description" && b.found == "title") return -1;
				if(a.found == "title" && b.found == "title") {
					if(a.index > b.index) return -1;
					if(a.index < b.index) return 1;
					if(a.index == b.index) return 0;
				}
				if(a.found == "description" && b.found == "description") {
					if(a.index > b.index) return -1;
					if(a.index < b.index) return 1;
					if(a.index == b.index) return 0;
				}
				return 0;
			})
			// console.log(rues)
			var str = rues.pop();
			// console.log(str)
			if(Math.abs(str.lat-krakow.lat)+Math.abs(str.lng-krakow.lng) > 0.0000002){
				f.position = str;
				f.icon = orangeIcon;
			} else {
				return true;
			}
		} else {
			// bezlocation.push(f)
			// bezText = bezText + textwind(f);
			return true;
		}
		f.marker = new google.maps.Marker({
			position: f.position,
			map: isFiltered(f) ? map : null,
			title: f.title,
			icon: f.icon
		});
		// log(isFiltered(f))
	})
}

function addRemove(){
	flats.forEach(f => {

		if(f.marker){
			if(isFiltered(f)){
				if(!f.marker.map)
				f.marker.setMap(map);
			} else {
				f.marker.setMap(null)
			}
		}
	})
	addDialogs();
}

function isFiltered(f){
	var auj = today ? f.today : true;
	// if( == undefined)
	// console.log(f.pricenumber <= price && auj,f.website,websites[f.website])
	return f.pricenumber <= price && auj && websites[f.website]
}


function saveClick(f){
	// log('users/'+user+'/clicks/'+f.id)
	database.ref('users/'+user+'/clicks/'+f.id).update({date: new Date()});
}

function textwind(f){
	return '<div class="infowindow">'
		+ f["Data dodania"] + "<br><b>"
		+ f.title + '</b><br><span class="price">'
		+ f.price + '</span><br><a id="'+ f.id +'" href="'+ f.href +'" target="_blank">'+ lien[lang] + websiteText[f.website] +'</a><br></div>'
}
var lien = {
	en: "See on ",
	fr: "Voir sur ",
	pl: "Zobacz na "
}
var websiteText = {
	gumtree: "Gumtree",
	otodom: "Otodom",
	gratka: "Gratka"
}

var orangeIcon = "http://maps.google.com/mapfiles/ms/icons/orange-dot.png";
var redIcon = "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
var blueIcon = "http://maps.google.com/mapfiles/ms/icons/blue-dot.png";


$.get( "https://thawing-citadel-9733.herokuapp.com/update", function( data ) {
  console.log(data);
});

var user;
if(location.hostname == "localhost") {
    localStorage.user = "Gaspard";
    user = localStorage.user;
} else if(!localStorage.user){
    localStorage.user = Date.now();
    user = localStorage.user;
}

// tracking users once
if(localStorage.user != "Gaspard"){
    var obj = {}
    var d = new Date();
    var text = "0"+(d.getMonth()+1)+"-"+d.getDate()+" "+(d.getHours()<10?"0"+d.getHours():d.getHours() )+":"+(d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes() )+":"+(d.getSeconds()<10?"0"+d.getSeconds():d.getSeconds());
    obj[text] = localStorage.user + " " + lang + " from "+navigator.language;
    database.ref("pings").update(obj)
}

</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBG0dOVS_ZhMTnoprt3-pxQUVlpgalraqM&callback=initMap"></script>
</body>
</html>